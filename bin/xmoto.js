// Generated by CoffeeScript 1.6.3
(function() {
  var Assets, Blocks, Entities, Infos, LayerOffsets, Level, Limits, Physics, Script, Sky, b2AABB, b2Body, b2BodyDef, b2CircleShape, b2DebugDraw, b2Fixture, b2FixtureDef, b2MassData, b2MouseJointDef, b2PolygonShape, b2Vec2, b2World;

  Assets = (function() {
    function Assets() {
      this.queue = new createjs.LoadQueue();
      this.list = [];
      this.textures = [];
      this.anims = [];
    }

    Assets.prototype.load_for_level = function(level, callback) {
      var item, items, _i, _j, _len, _len1, _ref, _ref1;
      items = [];
      _ref = this.textures;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        items.push({
          id: item,
          src: "data/Textures/Textures/" + item + ".jpg"
        });
      }
      _ref1 = this.anims;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        item = _ref1[_j];
        items.push({
          id: item,
          src: "data/Textures/Anims/" + item + ".png"
        });
      }
      this.queue.addEventListener("complete", callback);
      return this.queue.loadManifest(items);
    };

    Assets.prototype.get = function(name) {
      return this.queue.getResult(name);
    };

    return Assets;

  })();

  Blocks = (function() {
    function Blocks(level) {
      this.level = level;
      this.assets = level.assets;
      this.list = [];
    }

    Blocks.prototype.parse = function(xml) {
      var block, material, vertex, xml_block, xml_blocks, xml_material, xml_materials, xml_vertex, xml_vertices, _i, _j, _k, _len, _len1, _len2;
      xml_blocks = $(xml).find('block');
      this.list = [];
      for (_i = 0, _len = xml_blocks.length; _i < _len; _i++) {
        xml_block = xml_blocks[_i];
        block = {
          id: $(xml_block).attr('id'),
          position: {
            x: parseFloat($(xml_block).find('position').attr('x')),
            y: parseFloat($(xml_block).find('position').attr('y')),
            dynamic: $(xml_block).find('position').attr('dynamic'),
            background: $(xml_block).find('position').attr('background')
          },
          usetexture: {
            id: $(xml_block).find('usetexture').attr('id').toLowerCase(),
            scale: parseFloat($(xml_block).find('usetexture').attr('scale'))
          },
          physics: {
            grip: parseFloat($(xml_block).find('physics').attr('grip'))
          },
          edges: {
            angle: parseFloat($(xml_block).find('edges').attr('angle')),
            materials: []
          },
          vertices: []
        };
        xml_materials = $(xml_block).find('edges material');
        for (_j = 0, _len1 = xml_materials.length; _j < _len1; _j++) {
          xml_material = xml_materials[_j];
          material = {
            name: $(xml_material).attr('name'),
            edge: $(xml_material).attr('edge'),
            color_r: parseInt($(xml_material).attr('color_r')),
            color_g: parseInt($(xml_material).attr('color_g')),
            color_b: parseInt($(xml_material).attr('color_b')),
            color_a: parseInt($(xml_material).attr('color_a')),
            scale: parseFloat($(xml_material).attr('scale')),
            depth: parseFloat($(xml_material).attr('depth'))
          };
          block.edges.materials.push(material);
        }
        xml_vertices = $(xml_block).find('vertex');
        for (_k = 0, _len2 = xml_vertices.length; _k < _len2; _k++) {
          xml_vertex = xml_vertices[_k];
          vertex = {
            x: parseFloat($(xml_vertex).attr('x')),
            y: parseFloat($(xml_vertex).attr('y')),
            edge: $(xml_vertex).attr('edge')
          };
          block.vertices.push(vertex);
        }
        this.list.push(block);
      }
      return this;
    };

    Blocks.prototype.load_assets = function() {
      var block, _i, _len, _ref, _results;
      _ref = this.list;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        block = _ref[_i];
        this.assets.list.push(block.usetexture.id);
        _results.push(this.assets.textures.push(block.usetexture.id));
      }
      return _results;
    };

    Blocks.prototype.display = function(ctx) {
      var block, i, vertex, _i, _j, _len, _len1, _ref, _ref1, _results;
      _ref = this.list;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        block = _ref[_i];
        ctx.beginPath();
        _ref1 = block.vertices;
        for (i = _j = 0, _len1 = _ref1.length; _j < _len1; i = ++_j) {
          vertex = _ref1[i];
          if (i === 0) {
            ctx.moveTo(block.position.x + vertex.x, block.position.y + vertex.y);
          } else {
            ctx.lineTo(block.position.x + vertex.x, block.position.y + vertex.y);
          }
        }
        ctx.closePath();
        ctx.save();
        ctx.scale(1.0 / this.level.scale.x, 1.0 / this.level.scale.y);
        ctx.fillStyle = ctx.createPattern(this.assets.get(block.usetexture.id), "repeat");
        ctx.fill();
        _results.push(ctx.restore());
      }
      return _results;
    };

    return Blocks;

  })();

  Entities = (function() {
    function Entities(level) {
      this.level = level;
      this.assets = level.assets;
      this.list = [];
    }

    Entities.prototype.parse = function(xml) {
      var entity, param, xml_entities, xml_entity, xml_param, xml_params, _i, _j, _len, _len1;
      xml_entities = $(xml).find('entity');
      for (_i = 0, _len = xml_entities.length; _i < _len; _i++) {
        xml_entity = xml_entities[_i];
        entity = {
          id: $(xml_entity).attr('id'),
          type_id: $(xml_entity).attr('typeid'),
          size: {
            r: parseFloat($(xml_entity).find('size').attr('r')),
            width: parseFloat($(xml_entity).find('size').attr('width')),
            height: parseFloat($(xml_entity).find('size').attr('height'))
          },
          position: {
            x: parseFloat($(xml_entity).find('position').attr('x')),
            y: parseFloat($(xml_entity).find('position').attr('y')),
            angle: parseFloat($(xml_entity).find('position').attr('angle'))
          },
          params: []
        };
        xml_params = $(xml_entity).find('param');
        for (_j = 0, _len1 = xml_params.length; _j < _len1; _j++) {
          xml_param = xml_params[_j];
          param = {
            name: $(xml_param).attr('name'),
            value: $(xml_param).attr('value').toLowerCase()
          };
          entity.params.push(param);
        }
        this.list.push(entity);
      }
      return this;
    };

    Entities.prototype.load_assets = function() {
      var entity, param, _i, _len, _ref, _results;
      _ref = this.list;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entity = _ref[_i];
        if (entity.type_id === 'Sprite') {
          _results.push((function() {
            var _j, _len1, _ref1, _results1;
            _ref1 = entity.params;
            _results1 = [];
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              param = _ref1[_j];
              if (param.name === 'name') {
                this.assets.list.push(param.value);
                _results1.push(this.assets.anims.push(param.value));
              } else {
                _results1.push(void 0);
              }
            }
            return _results1;
          }).call(this));
        } else if (entity.type_id === 'EndOfLevel') {
          this.assets.list.push('flower00');
          _results.push(this.assets.anims.push('flower00'));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    Entities.prototype.display = function(ctx) {
      var entity, image, param, _i, _j, _len, _len1, _ref, _ref1, _results;
      _ref = this.list;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entity = _ref[_i];
        if (entity.type_id === 'Sprite') {
          _ref1 = entity.params;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            param = _ref1[_j];
            if (param.name === 'name') {
              image = param.value;
            }
          }
          ctx.save();
          ctx.translate(entity.position.x, entity.position.y);
          ctx.scale(1, -1);
          ctx.drawImage(this.assets.get(image), 0, 0, entity.size.r * 4, -entity.size.r * 4);
          _results.push(ctx.restore());
        } else if (entity.type_id === 'EndOfLevel') {
          ctx.save();
          ctx.translate(entity.position.x - entity.size.r, entity.position.y - entity.size.r);
          ctx.scale(1, -1);
          ctx.drawImage(this.assets.get('flower00'), 0, 0, entity.size.r * 4, -entity.size.r * 4);
          _results.push(ctx.restore());
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    return Entities;

  })();

  Infos = (function() {
    function Infos(level) {
      this.level = level;
      this.assets = level.assets;
    }

    Infos.prototype.parse = function(xml) {
      var xml_border, xml_infos, xml_level, xml_music;
      xml_level = $(xml).find('level');
      this.identifier = xml_level.attr('id');
      this.pack_name = xml_level.attr('levelpack');
      this.pack_id = xml_level.attr('levelpackNum');
      this.r_version = xml_level.attr('rversion');
      xml_infos = $(xml).find('level').find('info');
      this.name = xml_infos.find('name').text();
      this.description = xml_infos.find('description').text();
      this.author = xml_infos.find('author').text();
      this.date = xml_infos.find('date').text();
      xml_border = xml_infos.find('border');
      this.border = xml_border.attr('texture');
      xml_music = xml_infos.find('music');
      this.music = xml_music.attr('name');
      return this;
    };

    Infos.prototype.load_assets = function() {};

    Infos.prototype.display = function(ctx) {};

    return Infos;

  })();

  LayerOffsets = (function() {
    function LayerOffsets(level) {
      this.level = level;
      this.assets = level.assets;
      this.list = [];
    }

    LayerOffsets.prototype.parse = function(xml) {
      var layer_offset, xml_layer_offset, xml_layer_offsets, _i, _len;
      xml_layer_offsets = $(xml).find('layeroffsets layeroffset');
      for (_i = 0, _len = xml_layer_offsets.length; _i < _len; _i++) {
        xml_layer_offset = xml_layer_offsets[_i];
        layer_offset = {
          x: parseFloat($(xml_layer_offset).attr('x')),
          y: parseFloat($(xml_layer_offset).attr('y')),
          front_layer: $(xml_layer_offset).attr('frontlayer')
        };
        this.list.push(layer_offset);
      }
      return this;
    };

    LayerOffsets.prototype.load_assets = function() {};

    LayerOffsets.prototype.display = function(ctx) {};

    return LayerOffsets;

  })();

  Level = (function() {
    function Level() {
      this.assets = new Assets();
      this.infos = new Infos(this);
      this.sky = new Sky(this);
      this.blocks = new Blocks(this);
      this.limits = new Limits(this);
      this.layer_offsets = new LayerOffsets(this);
      this.script = new Script(this);
      this.entities = new Entities(this);
    }

    Level.prototype.load_from_file = function(file_name) {
      return $.ajax({
        type: "GET",
        url: "data/Levels/" + file_name,
        dataType: "xml",
        success: this.load_level,
        async: false,
        context: this
      });
    };

    Level.prototype.load_level = function(xml) {
      this.infos.parse(xml).load_assets();
      this.sky.parse(xml).load_assets();
      this.blocks.parse(xml).load_assets();
      this.limits.parse(xml).load_assets();
      this.layer_offsets.parse(xml).load_assets();
      this.script.parse(xml).load_assets();
      return this.entities.parse(xml).load_assets();
    };

    Level.prototype.load_assets = function(callback) {
      return this.assets.load_for_level(this, callback);
    };

    Level.prototype.draw = function() {
      var canvas, canvas_height, canvas_width, translate;
      canvas = $('#game').get(0);
      canvas_width = parseFloat(canvas.width);
      canvas_height = canvas.width * (this.limits.size.y / this.limits.size.x);
      $('#game').attr('height', canvas_height);
      this.ctx = canvas.getContext('2d');
      this.scale = {
        x: canvas_width / this.limits.size.x,
        y: -canvas_height / this.limits.size.y
      };
      translate = {
        x: -this.limits.screen.left,
        y: -this.limits.screen.top
      };
      this.ctx.scale(this.scale.x, this.scale.y);
      this.ctx.translate(translate.x, translate.y);
      this.ctx.lineWidth = 0.1;
      this.sky.display(this.ctx);
      this.limits.display(this.ctx);
      this.blocks.display(this.ctx);
      return this.entities.display(this.ctx);
    };

    Level.prototype.triangulate = function() {
      var block, set_of_triangles, triangle, triangulation, vertex, vertices, _i, _j, _len, _len1, _ref, _ref1, _results;
      this.triangles = [];
      _ref = this.blocks.list;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        block = _ref[_i];
        vertices = [];
        _ref1 = block.vertices;
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          vertex = _ref1[_j];
          vertices.push(new poly2tri.Point(block.position.x + vertex.x, block.position.y + vertex.y));
        }
        triangulation = new poly2tri.SweepContext(vertices, {
          cloneArrays: true
        });
        triangulation.triangulate();
        set_of_triangles = triangulation.getTriangles();
        _results.push((function() {
          var _k, _len2, _results1;
          _results1 = [];
          for (_k = 0, _len2 = set_of_triangles.length; _k < _len2; _k++) {
            triangle = set_of_triangles[_k];
            _results1.push(this.triangles.push([
              {
                x: triangle.points_[0].x,
                y: triangle.points_[0].y
              }, {
                x: triangle.points_[1].x,
                y: triangle.points_[1].y
              }, {
                x: triangle.points_[2].x,
                y: triangle.points_[2].y
              }
            ]));
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    return Level;

  })();

  $(function() {
    var level;
    level = new Level();
    level.load_from_file('l1038.lvl');
    return level.load_assets(function() {
      var ball, physics, triangle, update, world, _i, _len, _ref;
      level.triangulate();
      level.draw();
      physics = new Physics(30);
      world = physics.createWorld(level.ctx);
      ball = physics.createBall(world, 1, 7, 1, false, 'ball' + i);
      _ref = level.triangles;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        triangle = _ref[_i];
        physics.createTriangle(world, triangle, true, []);
      }
      update = function() {
        level.draw();
        world.Step(1 / 60, 10, 10);
        world.DrawDebugData();
        return world.ClearForces();
      };
      return setInterval(update, 1000 / 60);
    });
  });

  Limits = (function() {
    function Limits(level) {
      this.level = level;
      this.assets = level.assets;
    }

    Limits.prototype.parse = function(xml) {
      var xml_limits;
      xml_limits = $(xml).find('limits');
      this.screen = {
        left: parseFloat(xml_limits.attr('left')) * 1.15,
        right: parseFloat(xml_limits.attr('right')) * 1.15,
        top: parseFloat(xml_limits.attr('top')) * 1.15,
        bottom: parseFloat(xml_limits.attr('bottom')) * 1.15
      };
      this.player = {
        left: parseFloat(xml_limits.attr('left')),
        right: parseFloat(xml_limits.attr('right')),
        top: parseFloat(xml_limits.attr('top')),
        bottom: parseFloat(xml_limits.attr('bottom'))
      };
      this.size = {
        x: this.screen.right - this.screen.left,
        y: this.screen.top - this.screen.bottom
      };
      return this;
    };

    Limits.prototype.load_assets = function() {
      this.assets.list.push('dirt');
      return this.assets.textures.push('dirt');
    };

    Limits.prototype.display = function(ctx) {
      ctx.beginPath();
      ctx.moveTo(this.screen.left, this.screen.top);
      ctx.lineTo(this.screen.left, this.screen.bottom);
      ctx.lineTo(this.player.left, this.screen.bottom);
      ctx.lineTo(this.player.left, this.screen.top);
      ctx.closePath();
      ctx.save();
      ctx.scale(1.0 / this.level.scale.x, 1.0 / this.level.scale.y);
      ctx.fillStyle = ctx.createPattern(this.assets.get('dirt'), "repeat");
      ctx.fill();
      ctx.restore();
      ctx.beginPath();
      ctx.moveTo(this.screen.right, this.screen.top);
      ctx.lineTo(this.screen.right, this.screen.bottom);
      ctx.lineTo(this.player.right, this.screen.bottom);
      ctx.lineTo(this.player.right, this.screen.top);
      ctx.closePath();
      ctx.save();
      ctx.scale(1.0 / this.level.scale.x, 1.0 / this.level.scale.y);
      ctx.fillStyle = ctx.createPattern(this.assets.get('dirt'), "repeat");
      ctx.fill();
      ctx.restore();
      ctx.beginPath();
      ctx.moveTo(this.player.right, this.player.bottom);
      ctx.lineTo(this.player.left, this.player.bottom);
      ctx.lineTo(this.player.left, this.screen.bottom);
      ctx.lineTo(this.player.right, this.screen.bottom);
      ctx.closePath();
      ctx.save();
      ctx.scale(1.0 / this.level.scale.x, 1.0 / this.level.scale.y);
      ctx.fillStyle = ctx.createPattern(this.assets.get('dirt'), "repeat");
      ctx.fill();
      return ctx.restore();
    };

    return Limits;

  })();

  b2World = Box2D.Dynamics.b2World;

  b2Vec2 = Box2D.Common.Math.b2Vec2;

  b2AABB = Box2D.Collision.b2AABB;

  b2BodyDef = Box2D.Dynamics.b2BodyDef;

  b2Body = Box2D.Dynamics.b2Body;

  b2FixtureDef = Box2D.Dynamics.b2FixtureDef;

  b2Fixture = Box2D.Dynamics.b2Fixture;

  b2MassData = Box2D.Collision.Shapes.b2MassData;

  b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;

  b2CircleShape = Box2D.Collision.Shapes.b2CircleShape;

  b2DebugDraw = Box2D.Dynamics.b2DebugDraw;

  b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef;

  Physics = (function() {
    function Physics(scale) {
      this.SCALE = scale;
    }

    Physics.prototype.createWorld = function(context) {
      var debugDraw, world;
      world = new b2World(new b2Vec2(0, -10), true);
      debugDraw = new b2DebugDraw();
      debugDraw.SetSprite(context);
      debugDraw.SetFillAlpha(0.3);
      debugDraw.SetLineThickness(1.0);
      debugDraw.SetDrawScale(this.SCALE);
      debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
      world.SetDebugDraw(debugDraw);
      return world;
    };

    Physics.prototype.createBody = function(type, world, x, y, dimensions, fixed, userData) {
      var bodyDef, fixDef;
      if (typeof fixed === 'undefined') {
        fixed = true;
      }
      fixDef = new b2FixtureDef();
      fixDef.userData = userData;
      switch (type) {
        case 'box':
          fixDef.shape = new b2PolygonShape();
          fixDef.shape.SetAsBox(dimensions.width / this.SCALE, dimensions.height / this.SCALE);
          break;
        case 'ball':
          fixDef.shape = new b2CircleShape(dimensions.radius / this.SCALE);
      }
      bodyDef = new b2BodyDef();
      bodyDef.position.x = x / this.SCALE;
      bodyDef.position.y = y / this.SCALE;
      if (fixed) {
        bodyDef.type = b2Body.b2_staticBody;
      } else {
        bodyDef.type = b2Body.b2_dynamicBody;
        fixDef.density = 1.0;
        fixDef.restitution = 0.5;
      }
      return world.CreateBody(bodyDef).CreateFixture(fixDef);
    };

    Physics.prototype.createBox = function(world, x, y, width, height, fixed, userData) {
      var dimensions;
      dimensions = {
        width: width,
        height: height
      };
      return this.createBody('box', world, x, y, dimensions, fixed, userData);
    };

    Physics.prototype.createBall = function(world, x, y, radius, fixed, userData) {
      var dimensions;
      dimensions = {
        radius: radius
      };
      return this.createBody('ball', world, x, y, dimensions, fixed, userData);
    };

    Physics.prototype.createTriangle = function(world, vertices, fixed, userData) {
      var bodyDef, fixDef;
      if (typeof fixed === 'undefined') {
        fixed = true;
      }
      fixDef = new b2FixtureDef();
      fixDef.userData = userData;
      fixDef.shape = new b2PolygonShape();
      fixDef.shape.SetAsArray([new b2Vec2(vertices[0].x / this.SCALE, vertices[0].y / this.SCALE), new b2Vec2(vertices[1].x / this.SCALE, vertices[1].y / this.SCALE), new b2Vec2(vertices[2].x / this.SCALE, vertices[2].y / this.SCALE)]);
      bodyDef = new b2BodyDef();
      bodyDef.position.x = 0;
      bodyDef.position.y = 0;
      if (fixed) {
        bodyDef.type = b2Body.b2_staticBody;
      } else {
        bodyDef.type = b2Body.b2_dynamicBody;
        fixDef.density = 1.0;
        fixDef.restitution = 0.5;
      }
      return world.CreateBody(bodyDef).CreateFixture(fixDef);
    };

    return Physics;

  })();

  Script = (function() {
    function Script(level) {
      this.level = level;
      this.assets = level.assets;
    }

    Script.prototype.parse = function(xml) {
      var xml_script;
      xml_script = $(xml).find('script');
      this.code = xml_script.text();
      return this;
    };

    Script.prototype.load_assets = function() {};

    Script.prototype.display = function(ctx) {};

    return Script;

  })();

  Sky = (function() {
    function Sky(level) {
      this.level = level;
      this.assets = level.assets;
    }

    Sky.prototype.parse = function(xml) {
      var xml_sky;
      xml_sky = $(xml).find('level info sky');
      this.name = xml_sky.text().toLowerCase();
      this.color_r = parseInt(xml_sky.attr('color_r'));
      this.color_g = parseInt(xml_sky.attr('color_g'));
      this.color_b = parseInt(xml_sky.attr('color_b'));
      this.color_a = parseInt(xml_sky.attr('color_a'));
      this.zoom = parseFloat(xml_sky.attr('zoom'));
      this.offset = parseFloat(xml_sky.attr('offset'));
      return this;
    };

    Sky.prototype.load_assets = function() {
      this.assets.list.push(this.name);
      return this.assets.textures.push(this.name);
    };

    Sky.prototype.display = function(ctx) {
      return ctx.drawImage(this.assets.get(this.name), this.level.limits.screen.left, this.level.limits.screen.bottom, this.level.limits.size.x, this.level.limits.size.y);
    };

    return Sky;

  })();

}).call(this);
